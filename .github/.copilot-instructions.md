# FreeRangeNotify - Copilot Instructions

## Project Overview
FreeRangeNotify is a universal notification service built in Go using Fiber framework, Elasticsearch, and Redis. It provides multi-channel notifications (push, email, SMS, webhooks) with high performance and scalability.

## Project Structure
```
FreeRangeNotify/
├── cmd/                              # Application entry points
│   ├── server/main.go               # HTTP API server (Fiber-based)
│   ├── worker/main.go               # Background notification processor
│   └── migrate/main.go              # Database migration tool
├── internal/                        # Private application code
│   ├── config/
│   │   └── config.go                # Configuration management (Viper)
│   ├── domain/                      # Business logic domains
│   │   ├── application/
│   │   │   └── models.go            # Application entity and repository interface
│   │   ├── user/
│   │   │   └── models.go            # User entity with preferences and devices
│   │   ├── notification/
│   │   │   └── models.go            # Notification entity with status tracking
│   │   ├── template/
│   │   │   └── models.go            # Template entity
│   │   └── analytics/
│   │       └── models.go            # Analytics event entity
│   ├── infrastructure/              # External dependencies
│   │   ├── database/                # Elasticsearch implementations
│   │   │   ├── elasticsearch.go     # ES client with connection management
│   │   │   ├── index_templates.go   # Index mappings for all entities
│   │   │   ├── index_manager.go     # Index creation and migration
│   │   │   └── manager.go           # DatabaseManager coordination
│   │   ├── repository/              # Repository implementations
│   │   │   ├── base_repository.go   # Common ES operations
│   │   │   ├── application_repository.go
│   │   │   ├── user_repository.go
│   │   │   ├── notification_repository.go
│   │   │   └── mapper.go            # Struct/map conversion utilities
│   │   ├── queue/                   # Redis/Kafka queue implementations
│   │   ├── providers/               # FCM, APNS, SendGrid, Twilio
│   │   └── cache/                   # Cache implementations
│   ├── interfaces/                  # Interface adapters
│   │   ├── http/                    # Fiber HTTP handlers
│   │   ├── grpc/                    # gRPC handlers (future)
│   │   └── webhook/                 # Webhook handlers
│   └── usecases/                    # Application business logic
├── pkg/                             # Public packages
│   ├── logger/                      # Zap logging utilities
│   ├── validator/                   # Input validation
│   ├── errors/                      # Error handling
│   └── utils/                       # Common utilities
├── api/                             # API definitions
│   ├── openapi/                     # OpenAPI/Swagger specs
│   └── proto/                       # Protocol buffer definitions
├── config/                          # Configuration files
│   ├── config.yaml                  # Development config
│   └── config.prod.yaml             # Production config
├── deployments/                     # Deployment configurations
│   ├── docker/
│   │   └── prometheus.yml           # Prometheus configuration
│   ├── kubernetes/                  # K8s manifests (future)
│   └── terraform/                   # Infrastructure as code (future)
├── docs/                            # Documentation
│   ├── weekly-reports/
│   │   └── WEEK1_SUMMARY.md         # Week 1 implementation summary
│   └── FIBER_UPGRADE.md             # Performance upgrade documentation
├── scripts/                         # Build and utility scripts
│   ├── test-setup.sh                # Linux test script
│   └── test-setup.bat               # Windows test script
├── tests/                          # Test files
│   ├── integration/                 # Integration tests
│   └── load/                        # Load tests
├── docker-compose.yml               # Development services
├── docker-compose.dev.yml           # Development overrides
├── Dockerfile                       # Container definition
├── go.mod                           # Go module definition
├── go.sum                           # Go module checksums
├── .env.example                     # Environment variables template
├── .gitignore                       # Git exclusions
├── README.md                        # Project documentation
└── NOTIFICATION_SERVICE_DESIGN.md   # Comprehensive design document
```

## Technology Stack

### Core Technologies
- **Language**: Go 1.21+
- **Web Framework**: Fiber v2.52.9 (FastHTTP-based, 2.5x faster than Gin)
- **Database**: Elasticsearch 8.11.0
- **Cache/Queue**: Redis 7.x
- **Message Queue**: Kafka (production) / Redis (development)
- **Configuration**: Viper with YAML and environment variables

### Dependencies (go.mod)
```go
module github.com/the-monkeys/freerangenotify

require (
    github.com/gofiber/fiber/v2 v2.52.9
    github.com/elastic/go-elasticsearch/v8 v8.11.0
    github.com/go-redis/redis/v8 v8.11.5
    github.com/spf13/viper v1.17.0
    github.com/spf13/cobra v1.7.0
    go.uber.org/zap v1.26.0
    github.com/golang-jwt/jwt/v5 v5.0.0
    github.com/google/uuid v1.4.0
    github.com/stretchr/testify v1.8.4
    github.com/prometheus/client_golang v1.17.0
    github.com/opentracing/opentracing-go v1.2.0
    github.com/segmentio/kafka-go v0.4.47
    github.com/go-playground/validator/v10 v10.16.0
    github.com/joho/godotenv v1.5.1
)
```



### Prerequisites
```bash
# Required software
- Go 1.21+
- Docker and Docker Compose
- Git
```

### Quick Start Commands
```bash
# 1. Clone repository (future)
git clone https://github.com/the-monkeys/freerangenotify.git
cd freerangenotify

# 2. Install dependencies
go mod tidy

# 3. Start development services
docker-compose up -d

# 4. Verify Elasticsearch is ready (wait for healthy status)
curl http://localhost:9200/_cluster/health

# 5. Run the server (will auto-create indices on first run)
go run cmd/server/main.go

# 6. Test endpoints
curl http://localhost:8080/health
curl http://localhost:8080/database/stats
curl http://localhost:8080/version
curl http://localhost:8080/api/v1/status

# 7. Verify indices were created
curl http://localhost:9200/_cat/indices
```

### Environment Variables
```bash
# Copy environment template
cp .env.example .env

# Key variables to configure:
FREERANGE_APP_ENVIRONMENT=development
FREERANGE_DATABASE_URLS=http://localhost:9200
FREERANGE_REDIS_HOST=localhost
FCM_SERVER_KEY=your-fcm-key
SENDGRID_API_KEY=your-sendgrid-key
TWILIO_AUTH_TOKEN=your-twilio-token
```

## Architecture Patterns

### Clean Architecture Layers
1. **Domain Layer** (`internal/domain/`): Business entities and rules
2. **Use Cases Layer** (`internal/usecases/`): Application business logic
3. **Interface Layer** (`internal/interfaces/`): Controllers, handlers
4. **Infrastructure Layer** (`internal/infrastructure/`): External concerns

### Key Design Patterns
- **Repository Pattern**: Data access abstraction
- **Dependency Injection**: Loose coupling between components
- **Event-Driven Architecture**: Async processing with queues
- **Provider Pattern**: Pluggable notification channels
- **Circuit Breaker**: Fault tolerance for external services

## Database Schema (Elasticsearch Indices)

### Core Indices (Implemented ✅)
1. **applications** (1 shard): App registration, API keys, webhooks, settings
2. **users** (1 shard): User profiles, preferences, devices (nested), timezone, language
3. **notifications** (3 shards): Notification records with status tracking, high-volume optimized
4. **templates** (1 shard): Notification templates with variables and multi-channel support
5. **analytics** (5 shards): Time-series event data for delivery metrics

### Index Features
- **Auto-creation**: Indices automatically created on server startup
- **Health Checks**: Index existence validation in health endpoints
- **Migration Framework**: IndexManager handles schema migrations
- **Optimized Mappings**: Field-specific analyzers and disabled indexing for sensitive data
- **Nested Objects**: Support for complex structures (user devices, preferences)

### Index Naming Convention
```
{index_name}
Example: applications, users, notifications
Future: {environment}_{index_name}_{version} for production
```

## API Structure

### Current Endpoints

#### System Endpoints
```
GET  /health                # Service health check with database status
GET  /database/stats        # Database statistics and cluster info
GET  /version               # Version information
GET  /metrics               # Prometheus metrics endpoint
GET  /api/v1/status         # API operational status
GET  /swagger/*             # Swagger UI (interactive API documentation)
GET  /openapi/swagger.yaml  # OpenAPI 3.0 specification
```

#### Application Management (Public)
```
POST   /v1/apps                      # Register application
GET    /v1/apps/{id}                 # Get application details
PUT    /v1/apps/{id}                 # Update application
DELETE /v1/apps/{id}                 # Delete application
GET    /v1/apps                      # List applications (paginated)
POST   /v1/apps/{id}/regenerate-key  # Regenerate API key
PUT    /v1/apps/{id}/settings        # Update settings
GET    /v1/apps/{id}/settings        # Get settings
```

#### User Management (Protected - requires API key)
```
POST   /v1/users                     # Create user
GET    /v1/users/{id}                # Get user details
PUT    /v1/users/{id}                # Update user
DELETE /v1/users/{id}                # Delete user
GET    /v1/users                     # List users (paginated, filtered)
```

#### Device Management (Protected)
```
POST   /v1/users/{id}/devices                # Register device token
GET    /v1/users/{id}/devices                # Get all user devices
DELETE /v1/users/{id}/devices/{device_id}   # Unregister device
```

#### Preferences Management (Protected)
```
PUT    /v1/users/{id}/preferences    # Update user preferences
GET    /v1/users/{id}/preferences    # Get user preferences
```

### Planned API Routes (Week 5+)
```
# Notification APIs
POST   /v1/notifications           # Send notification
GET    /v1/notifications           # List notifications
GET    /v1/notifications/{id}      # Get notification details
PUT    /v1/notifications/{id}      # Update notification status
DELETE /v1/notifications/{id}      # Cancel scheduled notification
```

## Configuration Structure

### Configuration Files
- `config/config.yaml`: Development configuration
- `config/config.prod.yaml`: Production overrides
- `.env.example`: Environment variables template

### Configuration Hierarchy
1. Default values (in code)
2. Configuration files (YAML)
3. Environment variables (FREERANGE_ prefix)
4. Command line flags

## Docker Services

### Development Stack (docker-compose.yml)
```yaml
services:
  elasticsearch:    # Port 9200 - Data storage
  redis:           # Port 6379 - Cache/Queue
  kafka:           # Port 9092 - Message streaming
  zookeeper:       # Kafka dependency
  notification-service: # Port 8080 - Main API
  notification-worker:  # Background processor
  kibana:          # Port 5601 - ES management
  redis-commander: # Port 8081 - Redis management
  prometheus:      # Port 9090 - Metrics
  grafana:         # Port 3000 - Dashboards
```

## Performance Characteristics

### Fiber Framework Benefits
- **Speed**: ~100k requests/second (vs Gin's ~40k req/s)
- **Memory**: 30% less allocation
- **Latency**: 40% lower response times
- **CPU**: 20% reduced usage

### Scalability Targets
- **Throughput**: 100k+ notifications per second
- **Latency**: < 100ms API response time
- **Availability**: 99.9% uptime SLA
- **Durability**: Zero message loss guarantee

## Testing Strategy

### Test Types
1. **Unit Tests**: Individual component testing
2. **Integration Tests**: Service interaction testing
3. **Load Tests**: Performance and scalability testing
4. **End-to-End Tests**: Full workflow validation

### Test Commands
```bash
# Run all tests
go test ./...

# Run tests with coverage
go test -cover ./...

# Run integration tests
go test -tags=integration ./tests/integration/...

# Run load tests
go test -tags=load ./tests/load/...
```

## Monitoring and Observability

### Metrics Collection
- **Prometheus**: Application metrics
- **Grafana**: Visualization dashboards
- **Elasticsearch**: Log storage and search
- **Zap Logger**: Structured logging

### Key Metrics to Track
- Request latency and throughput
- Notification delivery rates
- Queue depth and processing time
- Error rates and types
- Resource utilization (CPU, memory, disk)

## Security Considerations

### Authentication & Authorization
- API Key authentication per application
- JWT tokens for user sessions (future)
- Rate limiting per API key
- CORS configuration for web clients

### Data Protection
- Input validation and sanitization
- SQL injection prevention (not applicable for ES)
- Secret management (environment variables)
- HTTPS/TLS for all communications

## Known Issues & Solutions

### Elasticsearch Text Field Queries
**Issue**: Elasticsearch text fields require `.keyword` suffix for exact term matching.

**Solution**: When using `term` queries on string fields, append `.keyword`:
```go
// ❌ Wrong - Will not match
map[string]interface{}{
    "term": map[string]interface{}{
        "api_key": apiKey,  // Text field analyzed
    },
}

// ✅ Correct - Exact match
map[string]interface{}{
    "term": map[string]interface{}{
        "api_key.keyword": apiKey,  // Keyword field
    },
}
```

**Affected Fields**:
- `api_key` → `api_key.keyword`
- `app_id` → `app_id.keyword`
- `email` → `email.keyword` (when doing exact match)
- Any string field used in term queries

## Development Guidelines

### Code Standards
- Follow Go conventions and gofmt
- Use meaningful variable and function names
- Write comprehensive tests for all new code
- Document public APIs and complex functions
- Use dependency injection for testability

### Git Workflow
- Feature branches for new development
- Descriptive commit messages with emojis
- PR reviews required for main branch
- Automated testing in CI/CD pipeline

### Error Handling
- Use structured error types
- Log errors with appropriate levels
- Return meaningful error messages to clients
- Implement circuit breakers for external services

## Future Development Phases

### Phase 2: Multi-Channel Support (Weeks 5-8)
- FCM and APNS push notifications
- SendGrid email integration
- Twilio SMS integration
- Template management system

### Phase 3: Advanced Features (Weeks 9-12)
- Scheduled notifications
- User preferences and quiet hours
- Rate limiting and throttling
- Retry mechanisms and error handling

### Phase 4: Scalability & Monitoring (Weeks 13-16)
- Horizontal scaling implementation
- Performance optimization
- Comprehensive monitoring
- Analytics and reporting

### Phase 5: Production Ready (Weeks 17-20)
- Security hardening
- GDPR compliance features
- SDK development
- Production deployment

## GitHub MCP Integration Notes

### Repository Settings
- **Repository**: `the-monkeys/freerangenotify`
- **Default Branch**: `main`
- **Protection Rules**: Require PR reviews, status checks
- **Issues**: Enable for bug tracking and feature requests
- **Projects**: Use for milestone tracking

### Recommended Labels
- `bug` - Bug fixes
- `feature` - New features
- `enhancement` - Improvements to existing features
- `documentation` - Documentation updates
- `performance` - Performance improvements
- `security` - Security-related changes
- `week-1`, `week-2`, etc. - Implementation phases

### Branch Strategy
- `main` - Production-ready code
- `develop` - Integration branch for features
- `feature/*` - Feature development branches
- `hotfix/*` - Critical bug fixes
- `release/*` - Release preparation branches

### CI/CD Pipeline (GitHub Actions)
```yaml
# Suggested workflow steps:
1. Lint and format code (golangci-lint)
2. Run unit tests with coverage
3. Run integration tests
4. Build Docker images
5. Deploy to staging environment
6. Run end-to-end tests
7. Deploy to production (manual approval)
```

## Common Commands Reference

### Development
```bash
# Start development environment
docker-compose up -d

# Run server with hot reload
go run cmd/server/main.go

# Run worker
go run cmd/worker/main.go

# Run migrations
go run cmd/migrate/main.go up

# Test setup
./scripts/test-setup.sh  # Linux
./scripts/test-setup.bat # Windows
```

### Docker Management
```bash
# Rebuild services
docker-compose build

# View logs
docker-compose logs -f notification-service

# Stop services
docker-compose down

# Clean up
docker-compose down -v --remove-orphans
```

### Database Operations
```bash
# Check Elasticsearch health
curl http://localhost:9200/_cluster/health

# View all indices with details
curl http://localhost:9200/_cat/indices?v

# Check specific index mapping
curl http://localhost:9200/applications/_mapping
curl http://localhost:9200/users/_mapping
curl http://localhost:9200/notifications/_mapping

# Get index statistics
curl http://localhost:9200/notifications/_stats

# Check application health with database status
curl http://localhost:8080/health
curl http://localhost:8080/database/stats

# Check Redis
redis-cli ping

# View Redis data
redis-cli keys "freerange:*"
```

This file serves as a comprehensive guide for understanding the FreeRangeNotify project structure, setup, and development workflow. Keep this updated as the project evolves through different phases.